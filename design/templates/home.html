<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</title>
    <link rel="stylesheet" href="/static/css/style.css" />
</head>
<body>
    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</h1>

    {% if user %}
        <p>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: {{ user.email }}</p>
        <form method="post" action="/auth/logout">
            <button type="submit">–í—ã–π—Ç–∏</button>
        </form>

        <h2>–ü–∞–ø–∫–∞: {{ current_folder.name if current_folder else "–ö–æ—Ä–Ω–µ–≤–∞—è" }}</h2>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤–≤–µ—Ä—Ö -->
        {% if current_folder and current_folder.parent %}
            <p><a href="/?folder_id={{ current_folder.parent.id }}">–í–≤–µ—Ä—Ö: {{ current_folder.parent.name }}</a></p>
        {% elif current_folder %}
            <p><a href="/">–í–≤–µ—Ä—Ö: –ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞</a></p>
        {% endif %}

        <!-- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–∞–ø–∫—É -->
        <h3>–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</h3>
        <form method="post" action="/folders">
            <input type="hidden" name="parent_id" value="{{ current_folder.id if current_folder else '' }}" />
            <input type="text" name="name" placeholder="–ò–º—è –ø–∞–ø–∫–∏" required />
            <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
        </form>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
        <h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h3>
        <form action="/file/upload" method="post" enctype="multipart/form-data">
            <input type="hidden" name="folder_id" value="{{ current_folder.id if current_folder else '' }}" />
            <input type="file" name="file" required />
            <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </form>

        {% if request.query_params.msg %}
            <div class="flash-message">{{ request.query_params.msg }}</div>
        {% endif %}

        <!-- –°–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫ -->
        <h3>–ü–∞–ø–∫–∏</h3>
        {% if folders %}
            <ul>
                {% for folder in folders %}
                    <li>
                        üìÅ <a href="/?folder_id={{ folder.id }}">{{ folder.name }}</a>
                        <button onclick="showRenameForm('{{ folder.id }}', '{{ folder.name }}')" class="rename-btn">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
                        <form method="post" action="/folders/delete/{{ folder.id }}" style="display:inline;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É {{ folder.name }}?');">
                            <button type="submit" class="delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                        
                        <!-- –§–æ—Ä–º–∞ –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞) -->
                        <div id="rename-form-{{ folder.id }}" style="display: none;">
                            <form onsubmit="renameFolder(event, '{{ folder.id }}')">
                                <input type="text" id="new-name-{{ folder.id }}" value="{{ folder.name }}" required />
                                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button type="button" onclick="hideRenameForm('{{ folder.id }}')">–û—Ç–º–µ–Ω–∞</button>
                            </form>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>–ü–∞–ø–æ–∫ –Ω–µ—Ç</p>
        {% endif %}

        <script>
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
            function showRenameForm(folderId, currentName) {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
                document.querySelectorAll('[id^="rename-form-"]').forEach(form => {
                    form.style.display = 'none';
                });
                
                const form = document.getElementById(`rename-form-${folderId}`);
                form.style.display = 'block';
                document.getElementById(`new-name-${folderId}`).value = currentName;
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
            function hideRenameForm(folderId) {
                document.getElementById(`rename-form-${folderId}`).style.display = 'none';
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
            async function renameFolder(event, folderId) {
                event.preventDefault();
                const newName = document.getElementById(`new-name-${folderId}`).value.trim();
                
                if (!newName) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –ø–∞–ø–∫–∏');
                    return;
                }
                
                try {
                    const response = await fetch(`/folders/${folderId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name: newName })
                    });
                    
                    if (response.ok) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤–æ–µ –∏–º—è
                        window.location.reload();
                    } else {
                        const error = await response.json();
                        alert(error.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ –ø–∞–ø–∫–∏');
                    }
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞:', err);
                    alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                }
            }
        </script>

        <!-- –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ -->
        <h3>–§–∞–π–ª—ã</h3>
        {% if files %}
            <ul>
                {% for file in files %}
                    <li>
                            {{ file.name }} 
                            <a href="/file/download/{{ file.id }}">–°–∫–∞—á–∞—Ç—å</a>
                            <a href="/versions/file/{{ file.id }}">–í–µ—Ä—Å–∏–∏</a>
                            <form method="post" action="/file/delete/{{ file.id }}" style="display:inline;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª {{ file.name }}?');">
                            <button type="submit" class="delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>–§–∞–π–ª–æ–≤ –Ω–µ—Ç</p>
        {% endif %}

    {% else %}
        <a href="/auth/login"><button>–í–æ–π—Ç–∏</button></a>
        <a href="/auth/register"><button>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button></a>
    {% endif %}

    <script>
        function askToRefreshToken() {
            const shouldRefresh = confirm("–í–∞—à–∞ —Å–µ—Å—Å–∏—è —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á—ë—Ç. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø?");

            if (shouldRefresh) {
                fetch("/auth/refresh", {
                    method: "POST",
                    credentials: "include"
                }).then(response => {
                    if (response.ok) {
                        console.log("Access —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω");
                    } else {
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.");
                        window.location.href = "/auth/login";
                    }
                }).catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞:", error);
                    alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.");
                    window.location.href = "/auth/login";
                });
            } 
            else {
                console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞.");
            }
        }
        setTimeout(askToRefreshToken, 14 * 60 * 1000);
    </script>

</body>
</html>